# Быстрый старт - Правильная последовательность запросов

## Для Задания 2 (CRUD операции)

### Важно понимать:
- **Задание 2** - это создание сущностей (CRUD): Senders, Recipients, Couriers, Parcels, Deliveries
- **Задание 3** - это бизнес-операции, которые используют созданные сущности
- **Задание 4** - это безопасность (CSRF, Basic Auth, роли)

### Правильная последовательность для задания 2:

1. **Получите CSRF токен:**
   ```
   GET /api/csrf
   ```
   - Это установит cookie `XSRF-TOKEN` в Postman
   - Или просто сделайте любой GET запрос (например, `GET /api/senders`) - это тоже установит cookie

2. **Создайте сущности (POST запросы):**
   - `POST /api/senders` - создать отправителя
   - `POST /api/recipients` - создать получателя  
   - `POST /api/couriers` - создать курьера
   - `POST /api/parcels` - создать посылку (нужны senderId и recipientId)
   - `POST /api/deliveries` - создать доставку (нужны parcelId и courierId)

3. **Используйте созданные сущности в задании 3:**
   - `POST /api/business/orders` - создать заказ
   - И другие бизнес-операции

## Почему возникает ошибка 403?

**403 Forbidden** возникает когда:
- ❌ CSRF токен не получен (cookie `XSRF-TOKEN` не установлена)
- ❌ CSRF токен не отправляется в заголовке `X-XSRF-TOKEN`
- ❌ CSRF токен отправляется в query параметре (неправильно!)
- ❌ Используются неправильные учетные данные (нужен ADMIN для POST запросов)

## Решение проблемы 403:

### Вариант 1: Использовать "GET Get CSRF token" (РЕКОМЕНДУЕТСЯ)
1. Запустите запрос **"GET Get CSRF token"** из раздела **"Задание 4 - Безопасность"**
2. Проверьте консоль Postman - должно быть: `✅ CSRF Token from cookie saved: ...`
3. **ВАЖНО:** Токен сохранится в переменную коллекции `csrfToken`
4. Pre-request script автоматически использует этот токен для всех POST/PUT/DELETE запросов
5. Теперь все POST запросы будут работать

### Вариант 2: Сделать любой GET запрос с Basic Auth
1. Сделайте любой GET запрос с Basic Auth (например, `GET /api/senders` с учетными данными admin)
2. Это автоматически установит cookie `XSRF-TOKEN` и создаст сессию
3. Pre-request script автоматически прочитает токен из cookie или переменной
4. Теперь POST запросы будут работать

### Важно понимать:
- Токен сохраняется в **переменную коллекции** `csrfToken`
- Pre-request script использует эту переменную, если cookie не найдена
- Это работает, потому что токен уже сохранен в переменную при первом запросе

## Проверка:

1. **Откройте консоль Postman:** View → Show Postman Console
2. **Проверьте сообщения:**
   - ✅ `CSRF Token from cookie: ...` - токен прочитан
   - ❌ `CSRF Token not found` - токен не найден, нужно получить

3. **Проверьте cookies:**
   - Откройте Cookies в Postman
   - Должна быть cookie `XSRF-TOKEN` для `localhost`

4. **Проверьте заголовки запроса:**
   - В запросе должен быть заголовок `X-XSRF-TOKEN: <token>`
   - В URL НЕ должно быть query параметра с токеном!

## Типичные ошибки:

❌ **Неправильно:**
```
POST http://localhost:8080/api/senders?X-XSRF-TOKEN=...
```

✅ **Правильно:**
```
POST http://localhost:8080/api/senders
Headers:
  X-XSRF-TOKEN: <token>
  Authorization: Basic <credentials>
```

## Если все еще не работает:

1. **Очистите cookies** в Postman
2. **Перезапустите приложение**
3. **Получите CSRF токен заново** (GET /api/csrf или любой GET запрос)
4. **Проверьте учетные данные** - для POST нужен ADMIN
5. **Проверьте консоль Postman** - там будут сообщения о токене

