# Инструкция по исправлению ошибки 403 в Postman

## Проблема
Ошибка 403 Forbidden возникает из-за проблем с CSRF токенами:
- Токены могут не совпадать между cookie и заголовком
- Cookie может не читаться правильно
- Токен может передаваться в query параметре (что неправильно)
- UserDetailsService может быть не настроен правильно

## Решение

### Шаг 1: Очистите cookies в Postman

1. В Postman нажмите на иконку **Cookies** (внизу справа или через меню)
2. Найдите домен `localhost`
3. Удалите все cookies:
   - Нажмите на `X` рядом с `JSESSIONID`
   - Нажмите на `X` рядом с `XSRF-TOKEN`
   - Или нажмите **"Clear All Cookies"** внизу диалога

### Шаг 2: Переимпортируйте коллекцию

1. Удалите старую коллекцию из Postman (если она уже импортирована)
2. Импортируйте обновленную коллекцию `postman_collection.json`:
   - File → Import
   - Выберите файл `postman_collection.json`
   - Нажмите Import

### Шаг 3: Настройте переменные коллекции

1. Откройте коллекцию → вкладка **Variables**
2. Установите значения:
   - `adminPassword` - пароль админа (из консоли при запуске приложения)
   - `userUsername` и `userPassword` - учетные данные пользователя (если нужно)

### Шаг 4: Правильная последовательность запросов

**ВАЖНО:** Следуйте этой последовательности:

1. **Перезапустите приложение:**
   - Остановите приложение (если запущено)
   - Запустите заново
   - Это важно для применения изменений в SecurityConfig

2. **Сначала получите CSRF токен:**
   - Запустите запрос **"GET Get CSRF token"** из раздела **"Задание 4 - Безопасность"**
   - Этот запрос установит cookie `XSRF-TOKEN` в Postman
   - Pre-request script автоматически прочитает токен из cookie и сохранит в переменную
   - Проверьте в консоли Postman (View → Show Postman Console), что токен прочитан

3. **Затем используйте другие запросы:**
   - Все POST/PUT/DELETE запросы автоматически будут использовать правильный CSRF токен из cookie
   - Токен будет автоматически читаться из cookie перед каждым запросом
   - Убедитесь, что используете правильные учетные данные (admin для админских операций)

### Шаг 5: Проверьте, что токен НЕ в query параметре

**ВАЖНО:** Убедитесь, что в URL нет query параметра с токеном!

❌ **НЕПРАВИЛЬНО:**
```
POST http://localhost:8080/api/business/deliveries/1/assign?X-XSRF-TOKEN=...
```

✅ **ПРАВИЛЬНО:**
```
POST http://localhost:8080/api/business/deliveries/1/assign
```
(Токен должен быть только в заголовке `X-XSRF-TOKEN`, а не в URL!)

### Шаг 6: Если проблема сохраняется

1. **Очистите cookies снова** (Шаг 1)
2. **Перезапустите приложение** (чтобы получить новый CSRF токен)
3. **Получите CSRF токен заново** (Шаг 4.1)
4. **Проверьте консоль Postman** (View → Show Postman Console):
   - Должно быть сообщение: `CSRF Token from cookie: ...`
   - Если видите ошибку, значит cookie не установлена

## Как это работает

1. **Spring Security** устанавливает CSRF токен в cookie `XSRF-TOKEN` при первом запросе
2. **Pre-request script** в коллекции автоматически читает токен из cookie перед каждым запросом
3. **Токен отправляется** в заголовке `X-XSRF-TOKEN` (НЕ в query параметре!)
4. **Spring Security проверяет**, что токен в заголовке совпадает с токеном в cookie

## Дополнительные советы

- Если токен устарел, просто получите новый через "GET Get CSRF token"
- Не добавляйте токен вручную в URL - это вызовет ошибку 403
- Убедитесь, что используете правильные учетные данные (admin для админских операций, user для обычных)

